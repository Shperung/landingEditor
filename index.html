<html>
<head>
    <title></title>
    <meta charset="UTF-8">
    <style>
      .editable.bordered {
        box-shadow: 0 0 0 1px #000;
        padding: 3px;
      }

      .editable.bordered:focus {
        box-shadow: 0 0 0 2px green;
        padding: 3px;
      }

      .content-editable-block {
        display: flex;
        flex-direction: column;
        width: 50px;
        height: 100px;
        background-color: #ccc;
        padding: 5px;
        justify-content: center;
        position: fixed;
        right: 0;
        top: 50%;
        transform: translateY(-50%);
      }
    </style>
    
</head>

  <body>
    <h1 id="editable1" class="editable bordered" contenteditable="false">
        Heading 1</h1>
    <p id="editable2" class="editable bordered" contenteditable="false">Text block 1</p>
   
    <h2 id="editable3" class="editable bordered" contenteditable="false">
            Heading 2</h2>

   
    <section id="editable_s" class="editable bordered" contenteditable="false">
      <div>
        <p>Text block 2</p>
      </div>
    </section>



    <br>
    <h3 id="editable5" class="editable bordered" contenteditable="false">Heading 3</h3>
    <p id="editable6" class="editable bordered" contenteditable="false">Text 3gsxsx</p>
  
    <b id="editable_b" class="editable bordered" contenteditable="false">bold teg<br>g<br>g<br>g<br>g<br>g<br>xt 15555555<br><br><br><br><br><br></b>


    <!-- <script src="src/client.js"></script> -->
    <script>

      function editText(isEdit) {
        const editable = document.getElementsByClassName('editable');
        if (isEdit) {
          // edit
          [].forEach.call(editable, function (el) {
            el.classList.add("bordered");
            el.addEventListener('click', function() {    
              el.setAttribute("contenteditable", true);
              el.focus();    
            }, false);
            el.addEventListener('blur', function() {    
              el.setAttribute("contenteditable", false);
              const text = el.outerHTML;
              const id = el.getAttribute("id");
              const token = getCookie('token');
              if (text && id && token) {      
                fetch('http://localhost:3012/', {
                  method: 'POST',
                  headers: {
                    'Accept': 'application/json, text/plain, */*',
                    'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({text: text, id: id, token: token})
                }).then(res=> {
                  if (res.ok) {
                    console.log('text changed');
                  }
                });

              } else {
                console.log('not data');
                
              }
                
            }, false);
          });
        } else {
          [].forEach.call(editable, function (el) {
            el.classList.remove("bordered");
          });
        }
      }
     

      


      // если на странице /editable то добавляем кнопки
      const isEditadlePath = window.location.pathname === '/editable';
      
      if (isEditadlePath) {
        console.log('isEditadlePath', isEditadlePath);
        
        const editableBlock = document.createElement('div');
        editableBlock.className = "content-editable-block";
        editableBlock.innerHTML = `
        <button class="js--login-btn">login</button>
        <button class="js--logout-btn" hidden>logout</button>
        `;
        document.body.appendChild(editableBlock);
      }
      
      // логинизация

      // возвращает cookie с именем name, если есть, если нет, то undefined
      function getCookie(name) {
        var matches = document.cookie.match(new RegExp(
          "(?:^|; )" + name.replace(/([\.$?*|{}\(\)\[\]\\\/\+^])/g, '\\$1') + "=([^;]*)"
        ));
        return matches ? decodeURIComponent(matches[1]) : undefined;
      }
      
      const isEditadle = getCookie('token');
      console.log('isEditadle', isEditadle);
      editText(isEditadle);
      
      const loginBtn = document.querySelector('.js--login-btn');
      const logoutBtn = document.querySelector('.js--logout-btn');

      if (isEditadle) {
        loginBtn.setAttribute("hidden", true);
        logoutBtn.removeAttribute("hidden");
      }

      if (logoutBtn) {
        logoutBtn.addEventListener('click', function() {
          if (document.cookie.length) {
            wantLogout = confirm("Do you want logout now?");
            if (wantLogout) {
              document.cookie = 'token=;expires=Thu, 01 Jan 1970 00:00:01 GMT;';
              document.location.reload(true);
            }
          }
        })
      }


      if (loginBtn && !isEditadle) {
        console.log('loginBtn', loginBtn);
        
        loginBtn.addEventListener('click', function () {
          const promptUserName = prompt("Enter user name", '');
          if (promptUserName ){
            const promptUserPassword =   prompt("Enter password", '');    
            if(promptUserPassword) {
              fetch('http://localhost:3012/', {
                  method: 'POST',
                  headers: {
                    'Accept': 'application/json, text/plain, */*',
                    'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({userName: promptUserName, userPassword: promptUserPassword})
              })
              .then(response => {
                return response.json()
              })
              .then(data => {
                console.log('data', data);
                const date = new Date(new Date().getTime() + 86400000);
                document.cookie = `token=${data.token}; expires=${date.toUTCString()}`;
                loginBtn.setAttribute("hidden", true);
                logoutBtn.removeAttribute("hidden");
                alert('Successed login');
                editText(true);                
              })
              .catch(err => {
                console.log('err', err)
                alert('Wrong username or password');
              })
            }
          }          
        });        
      }
     
      
    </script>
  </body></html>